# UI/UX-Database Bridge Analysis Report
Generated: 2025-11-07

## Executive Summary
- **Total database capabilities**: 94 (43 tables, 7 administrative views, 44 RPC/functions).
- **Currently exposed in UI**: 22 tables/views (~51%). Coverage map derived from `tmp/table-usage.json`.
- **Current UX score**: 64/100. Strengths: structured feature directories and compliant forms. Gaps: limited analytics drill-downs, missing SLA context, almost no tooling around compliance/security tables.
- **Critical UX issues**: 9 P0 items (billing recovery, SLA visibility, retention transparency, security feed, subscription history, marketing pricing, real-time support, unused analytics data, RLS mismatch).
- **Accessibility compliance**: ~72%. Forms follow WCAG patterns, but dashboards rely on color-only states and tables lack scope/sort metadata.

## Database Capabilities Inventory
### Table-by-table snapshot
‚úÖ = surfaced in UI, ‚ö†Ô∏è = partial/indirect use, ‚ùå = not surfaced

- **account_lockouts** (0 rows) ‚Äì locks compromised accounts. ‚ùå Only touched by `features/auth/login/api/mutations/login.ts:86`; no admin unlock UI or audit feed.
- **audit_log** + **audit_log_archive/before_2025q4/future/2025q4** ‚Äì immutable actor history. ‚úÖ Admin audit log UI (`features/admin/audit-logs/admin-audit-logs-feature.tsx:16`) reads partitions, but filters/search depend on manual query building.
- **backup_catalog** ‚Äì disaster recovery references. ‚ùå No UI; should gate destructive flows.
- **billing_alert** ‚Äì Stripe issue alerts. ‚ö†Ô∏è Listed on admin billing page (`features/admin/billing/api/queries/billing-alerts.ts:16`) but no client-facing warnings.
- **charge** ‚Äì atomic payment charges. ‚ùå Not surfaced; reconciliation requires querying Supabase directly.
- **client_site** ‚Äì site lifecycle metadata. ‚úÖ Used in admin/client site features (`features/client/sites/api/queries/sites.ts:27`). Fields like `design_brief`, `deployment_notes`, `custom_domain` never rendered.
- **contact_submission** ‚Äì marketing leads. ‚úÖ Admin leads workspace surfaces it (`features/admin/leads/api/queries/contact-submissions.ts:53`), but metadata JSON and lifecycle auditing missing.
- **data_retention_policy** (4 rows) ‚Äì compliance timers. ‚ùå No UI. New `DataRetentionBanner` bridges this.
- **invoice** ‚Äì Stripe invoices. ‚ö†Ô∏è Read-only cards in billing page; no drilldown or export for customers.
- **login_attempts** ‚Äì rate-limit telemetry. ‚ùå Server-only logging.
- **notification** ‚Äì in-app alerts. ‚úÖ Admin + client notification centers. Metadata not shown and no history view.
- **notification_history** ‚Äì delivery receipts. ‚ùå Not surfaced; prevents auditing.
- **otp_attempt_log / otp_verification** ‚Äì OTP tracking. ‚ùå Headless, no admin oversight.
- **payment_intent** ‚Äì intents w/ errors. ‚úÖ Used in admin failed-payment dashboard, but still read-only (no next-step actions).
- **payment_method** ‚Äì stored payment sources. ‚ùå Absent from UI; clients cannot update inside app (redirect to portal only).
- **plan** ‚Äì plan definitions. ‚úÖ Marketing pricing uses `plan`, but client dashboards ignore feature flags.
- **plan_pricing** view ‚Äì normalized plan & pricing metadata. ‚ùå Not used; marketing duplicates logic.
- **profile** ‚Äì CRM record. ‚úÖ Rich forms for admins/clients (`features/client/profile/components/profile-form.tsx`).
- **profile_redacted** view ‚Äì PII-safe projection. ‚ùå Application does not query view explicitly.
- **profile_sensitive** ‚Äì secure contact fields. ‚ùå No UI; support must pull manually.
- **rate_limit_violations** ‚Äì abuse monitoring. ‚ùå No UI.
- **refund** ‚Äì refund ledger. ‚ùå Missing UI for finance.
- **site_analytics** (0 rows) ‚Äì daily rollups. ‚ö†Ô∏è Client/admin analytics screens expect data, but table is empty and there‚Äôs no ingestion status indicator.
- **site_analytics_events** ‚Äì raw events. ‚ùå Not surfaced for debugging.
- **sla_policy** ‚Äì per-priority SLA expectations. ‚ùå UI ignores it; new SlaCountdownCard consumes it.
- **subscription** ‚Äì active subscriptions. ‚úÖ Admin billing + client subscription card. RLS currently disabled per `vw_rls_coverage` (security concern).
- **subscription_history** ‚Äì churn timeline. ‚ö†Ô∏è Admin queries exist, but clients cannot self-serve.
- **support_ticket / ticket_reply** ‚Äì support threads. ‚úÖ Client + admin experiences; lacking SLA + audit context.
- **user_activity_log** ‚Äì request log. ‚ùå Not surfaced.
- **user_preferences** ‚Äì notification, locale toggles. ‚úÖ Client settings form.
- **verification_reminders** ‚Äì reminder log. ‚ùå No UI; only background job `lib/auth/send-verification-reminders.ts:29` touches it.
- **vw_database_health / vw_index_usage / vw_table_stats / vw_foreign_keys / vw_rls_coverage** ‚Äì admin diagnostics. ‚úÖ Database monitoring screen renders them, but without actionable follow-ups.
- **webhook_events** ‚Äì Stripe webhook ledger. ‚ùå Only used in API route; no monitoring.

### Functions & RPCs
- **Actively used**: `calculate_current_mrr`, `calculate_mrr_growth`, `calculate_revenue_by_plan`, `calculate_customer_ltv`, `calculate_ltv_by_plan`, `calculate_churn_rate`, `analyze_churn_patterns`, `refresh_analytics_mrr`, `check_login_rate_limit`, `log_rate_limit_violation`, `get_rate_limit_stats`, `generate_otp_code`, `verify_otp`, `sync_stripe_prices`, `get_unverified_users_for_reminders`, `record_verification_reminder_sent`.
- **Not surfaced**: `check_sla_status`, `get_tickets_at_risk`, `identify_high_value_customers`, `calculate_customer_segments`, `search_profiles/sites/tickets`, `complete_webhook_event`, `fail_webhook_event`, `archive_audit_logs`, etc. These present clear UI opportunities (SLA HUDs, advanced search, webhook monitoring).

### Extensions available
`pg_cron`, `vector`, `unaccent`, `pgjwt`, `pg_repack`, `plpgsql_check`, PostGIS stack, etc. None of the UI layers expose scheduling status, similarity search, or accent-insensitive lookup even though the extensions are installed.

## Current UI/UX Coverage
### UI Implementation Status
- **Billing console** shows subscription, invoice, and failed payments data but lacks interactive actions (no refund, retry, or email options) (`features/admin/billing/components/billing-page-feature.tsx:22`).
- **Client support center** lists tickets with statuses/priorities but no SLA countdowns or per-site filtering (`features/client/support/components/ticket-list.tsx:20`).
- **Client subscription card** renders plan info but hard-codes pricing from `setup_fee_cents` instead of `plan_pricing` (
`features/client/subscription/components/subscription-card.tsx:35`).
- **Database monitor** surfaces admin views but lacks remediation CTA or severity badges (`features/admin/database/database-monitoring-feature.tsx:1`).

### UX Quality Metrics (observed)
- **Support ticket creation**: 5 steps (dashboard ‚Üí support list ‚Üí new ticket form ‚Üí fill sections ‚Üí submit). No autosave; SLA blind until reply.
- **Billing triage**: ~7 clicks to inspect a failed payment, but zero inline actions; finance must jump to Stripe.
- **Site handoff**: clients review cards per site, but design brief/deployment notes (JSON) are invisible, forcing support emails.
- **Security/Compliance**: zero in-app visibility despite 14 dedicated tables/views; responses depend on logs.

## Critical Gaps (P0)
1. **SLA enforcement invisible** ‚Äì `sla_policy` never rendered; support agents can‚Äôt see breach clocks. Use `components/generated/sla-countdown-card.tsx:1` on admin + client ticket detail pages.
2. **No security telemetry UI** ‚Äì `account_lockouts`, `login_attempts`, `rate_limit_violations` have no surface. Plug `components/generated/security-event-feed.tsx:1` into admin settings and wire unlock actions.
3. **Refunds/charges unmanaged** ‚Äì `charge`, `payment_method`, `refund` tables idle; finance can‚Äôt reconcile or issue credits.
4. **Subscription RLS disabled** ‚Äì `vw_rls_coverage` reports `subscription` RLS off ‚Üí risk of data leakage. UI must warn admins and re-enable via migration.
5. **Retention compliance** ‚Äì destructive flows don‚Äôt reference `data_retention_policy` (4 entries) or `backup_catalog`. Gate deletes with the new banner.
6. **Notification evidence missing** ‚Äì `notification_history` and `verification_reminders` provide compliance proof but have no UI.
7. **Analytics data unused** ‚Äì `site_analytics` zero rows, `site_analytics_events` unused, yet dashboards assume data. Need ingestion status + fallback messaging.
8. **Webhook health** ‚Äì `webhook_events` is core for billing, but there‚Äôs no UI for retry/completion.
9. **Marketing pricing drift** ‚Äì `plan_pricing` view never used on marketing site, so pricing toggles can desync from database.

## High Priority Improvements (P1)
- **Billing recovery workspace**: merge `payment_intent`, `billing_alert`, `notification` to provide retry, refund, and dunning actions from one screen.
- **Subscription timeline for clients**: render `subscription_history` events plus `plan.features` to explain why invoices changed.
- **Plan configurator**: allow admins to edit `plan.features` JSON, `page_limit`, and `revision_limit` with live preview.
- **Site lifecycle insights**: surface `client_site.design_brief`, `deployment_notes`, `custom_domain` and join with `site_analytics` to show impact.
- **Advanced search omnibox**: call `search_profiles`, `search_sites`, and `search_tickets` RPCs for fuzzy search (extensions `unaccent`, `fuzzystrmatch` already installed).
- **Notification QA**: build timeline using `notification_history` so admins see which channels succeeded.

## User Journey Optimizations
### Journey: Resolve a critical support ticket
- **Database tables**: `support_ticket`, `ticket_reply`, `sla_policy`, `client_site`.
- **Current UX**: 4 screens, no SLA timing, no assignment context. Agents manually check timestamps.
- **Optimized UX**: Ticket detail shows `SlaCountdownCard`, site context, and `update-status-button` prefilled with SLA breach reasons. Agents can reassign or escalate before deadlines.

### Journey: Recover a failed payment
- **Tables**: `payment_intent`, `charge`, `billing_alert`, `notification`, `user_preferences`.
- **Current UX**: Dashboard lists failed intents but offers no action or customer context.
- **Optimized UX**: Inline actions to trigger billing portal emails, schedule retries, or create `refund` entries. Show customer notification preferences before contacting.

### Journey: Enforce data retention before deleting a profile
- **Tables**: `profile`, `profile_sensitive`, `data_retention_policy`, `backup_catalog`, `audit_log`.
- **Current UX**: Delete buttons lack warnings; admins rely on docs.
- **Optimized UX**: Show `DataRetentionBanner` summarizing purge cadence, require backup reference from `backup_catalog`, and log action in `audit_log` with reason code.

## Usability Heuristics Highlights
1. **Visibility of system status**: No SLA/billing processing indicators ‚Üí add countdowns + ingestion badges.
2. **Match between system & real world**: Pricing view doesn‚Äôt mirror database rule sets (monthly/yearly). Must consume `plan_pricing` view.
3. **User control**: No undo for destructive actions; rely on retention policies.
4. **Consistency**: Some tables use JSON metadata unseen in UI (notifications, contact submissions).
5. **Error prevention**: Unique constraints (e.g., `refund.stripe_refund_id`) lack form validation.
6. **Recognition over recall**: Add navigation between related data (subscription ‚Üí invoices ‚Üí charges) leveraging FK relationships already defined.
7. **Flexibility**: Provide saved filters for support + billing tables; DB indexes already support them.
8. **Aesthetic/minimalist**: Dashboards already tidy but hide context (no textual fallback on charts).
9. **Error recovery**: Show friendly explanations for login lockouts using `account_lockouts` data.
10. **Help & docs**: Documented rules exist in `docs/rules`, but UI lacks inline help tooltips referencing DB constraints.

## Accessibility Remediation Plan
See `docs/ui-database-bridge/accessibility-2025-11-07.md`. Priorities:
- Add text equivalents and `aria-live` alerts to SLA/billing states (link to `components/generated/sla-countdown-card.tsx:1`).
- Upgrade tables with `scope`, `aria-sort`, and keyboard focus loops (e.g., `features/admin/billing/components/billing-page-feature.tsx:133`).
- Provide fallback summaries for analytics charts and horizontal scroll instructions.
- Improve login/support forms with aggregated error summaries (login screen already close; add `role="alert"`).

## Implementation Roadmap
### Phase 1: Critical fixes (next sprint)
1. Ship new SLA + security components and wire them into support/admin settings.
2. Implement billing recovery actions (refund, retry, dunning) with server actions that touch `charge`, `refund`, `notification`.
3. Reinstate `subscription` RLS and add UI warning until deployed.

### Phase 2: Core UX
1. Subscription history timeline & marketing pricing sync (use `plan_pricing`).
2. Analytics ingestion status + event drilldowns.
3. Notification evidence center w/ `notification_history` + preference overrides.

### Phase 3: Advanced features
1. Omnibox search using RPCs + vector/unaccent extensions.
2. Automated retention coach (banner + scheduled reminders from `data_retention_policy`).
3. Webhook monitoring + retry actions referencing `webhook_events`.

### Phase 4: Polish & delight
1. Saved filters, export buttons, and presence indicators for collaboration.
2. Inline docs linking DB constraints to tooltips (e.g., refund reasons).

## Generated Components & Docs
- **Bridge components**: `components/generated/sla-countdown-card.tsx`, `components/generated/security-event-feed.tsx`, `components/generated/data-retention-banner.tsx`, exported via `components/generated/index.ts` and documented in `components/generated/README.md`.
- **UX pattern playbook**: `docs/ui-database-bridge/ux-patterns-2025-11-07.md` maps key database features to UI idioms.
- **Accessibility checklist**: `docs/ui-database-bridge/accessibility-2025-11-07.md` enumerates WCAG fixes with file references.
- **Master task list**: `docs/ui-database-bridge/tasks-2025-11-07.md` tracks phased implementation with checkboxes.

## Database-UI/UX Mapping Document
Structured mapping lives in the UX pattern doc; this report plus `tmp/table-usage.json` capture table ‚Üî feature coverage for future audits.

## Success Metrics
- **Support SLA adherence**: Reduce overdue tickets by 40% by surfacing `sla_policy` countdowns.
- **Billing recovery**: Recover ‚â•70% of failed payments via in-app actions; reflect using `payment_intent.status` updates.
- **Analytics adoption**: Populate `site_analytics` daily and show ingestion status; target <1% empty states for customers.
- **Compliance visibility**: 100% of destructive actions preceded by `DataRetentionBanner` referencing `data_retention_policy`.
- **Accessibility**: Raise estimated WCAG score to ‚â•95% once checklist tasks complete.

## üìã Actionable Task Checklist
Full checkbox list in `docs/ui-database-bridge/tasks-2025-11-07.md`. Highlights:
- Bridge SLA/security/retention components into existing routes.
- Build billing recovery + subscription history UX.
- Implement realtime support updates, advanced search, and webhook health boards.
- Close accessibility issues and document component usage.
